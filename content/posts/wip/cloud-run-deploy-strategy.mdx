---
title: "Cloud Runで実現するローリング、ブルーグリーン、ハイブリッドデプロイ"
createdAt: "2025-05-10"
tags:
  - tech
  - googlecloud
  - cloudrun
type: "techtips"
---

コンテナアプリケーションのデプロイ・ホスト戦略の勉強、検討においてクラウドインフラを活かした方法を調査・検証していました。
ここでは、Google CloudのCloud Runを利用したコンテナアプリケーションのデプロイ戦略について解説します。

## Cloud Runとは

Cloud Runは、Google Cloudが提供するフルマネージドなコンテナ実行環境です。
[Cloud Run とは](https://cloud.google.com/run/docs/overview/what-is-cloud-run?hl=ja)にはこの表現はありませんが、**事実上サーバーレスアーキテクチャ**だと考えてもらってよいです。
つまり、**従量課金**で、かつ**リクエストに対するインフラのスケーリングはプラットフォームで自動**で行われ、さらに**リクエストが無い場合はゼロインスタンスまでスケールダウン**することが出来ます。

## リビジョン 公開単位の管理

はじめにCloud Runにおける**リビジョン**という概念を見ていきます。
これはデプロイ戦略を考えるにあたって一番重要な概念です。
リビジョンを理解できればデプロイ戦略はほぼ理解できたと言っても過言ではありません。

ドキュメント的な説明をすると、[リビジョンとはデプロイの単位](https://cloud.google.com/run/docs/resource-model?hl=ja#revisions)で、**環境変数、メモリ上限、リクエストの同時実行の値などの設定と、1 つ以上のコンテナ イメージで構成**されます
また、リビジョンはイミュータブルです。

ちょっとイメージしずらいんじゃないかと思います。
どういうことか、詳しく見ていきましょう。

### デプロイの単位

再掲すると、リビジョンはデプロイの単位で、各種設定値のセットと、コンテナイメージから構成されます。

これは例えば`some-image:v1.0.0`というイメージを作成し、各種環境変数を設定した設定値のセット`setting-A`が1つのデプロイの単位、つまり`revision-1`になるということです。

新しい処理を追加した場合やバグフィックスを行った場合、コンテナイメージが更新されるでしょう。
この場合イメージタグは`some-image:v1.0.1`となり、設定値の変更が不要な場合は`setting-A`をそのまま使えるので、この組み合わせが`revision-2`となります。

逆に、イメージに変更が無くても設定値を変更した場合は、`some-image:v1.0.1`と`setting-B`の組み合わせが`revision-3`となります。

表にすると次のような感じです

| リビジョン | イメージ          | 設定値    | 操作                                       |
| ---------- | ----------------- | --------- | ------------------------------------------ |
| revision-1 | some-image:v1.0.0 | setting-A | サービスの作成+初期デプロイ                |
| revision-2 | some-image:v1.0.1 | setting-A | イメージの更新をデプロイ                   |
| revision-3 | some-image:v1.0.1 | setting-B | 設定値の変更をデプロイ（環境変数などなど） |

このように見ていくと**リビジョンには変更というものが無く、何か処理（イメージ）や設定に変更がある場合は新しいリビジョンとして登録される**ことが分かります。
これがイミュータブルということです。

### リビジョンとサービスの公開

リビジョンが何か分かったところで、次に気になるのは**サービスとして提供されるのはどのリビジョン**か、ということです。
**これを制御するのがCloud Runの組み込みのトラフィック管理機構**です。

これは画面を見たら一発でわかります。

<Img src="/2025/cloud-run-deploy-strategy/revisions.png" alt="リビジョン一覧" />

リビジョンごとにトラフィックの割合を設定することが可能なことが分かります。
Cloud Runではサービス単位にメインとなるURLを持ち、そのURLへのアクセスはここで設定した割合に従って各リビジョンに振り分けられます。

**トラフィックを管理**リンクよりトラフィックの割合変更をGUIで簡単に行うことが出来ます。

<Img
  src="/2025/cloud-run-deploy-strategy/change_traffic.png"
  alt="リビジョン一覧"
/>

## ローリングデプロイ トラフィックの分割

以上の説明より、ローリングデプロイは極めて容易に実現できます。

1. 新しいリビジョンをトラフィックなしでデプロイする
2. 徐々にトラフィックを新しいリビジョンに振り分ける

Cloud Runではデプロイオプションとして新規リビジョンにトラフィックを振り分けないオプションがあります。（というより振り分けないがデフォルト）

<Img
  src="/2025/cloud-run-deploy-strategy/deploy_with_no_traffic.png"
  alt="リビジョン一覧"
/>

もちろん、`gcloud run deploy`コマンドのオプション（`--no-traffic`）も用意されています。

## ブルーグリーンデプロイ タグ付けによるリビジョンへの直接アクセス

トラフィックが流れないリビジョンを作成して、そこで動作を確認できるならブルーグリーンデプロイを実現できそうです。
しかし、**トラフィックを0%にしたリビジョンにどうアクセスすれば良い**のでしょうか？

ここで`Cloud Run`のリビジョンの機能である**タグ**を利用します。

<Img src="/2025/cloud-run-deploy-strategy/tagging.png" alt="リビジョン一覧" />

**リビジョンにはタグを付与することででき、このタグに対してメインのURLとは別にタグ固有のURLが割り当てられます**。
メインのURLは設定したトラフィック割合にしたがって各リビジョンに振り分けられますが、タグ固有のURLはトラフィック割合に関係なく、指定したリビジョンに直接アクセスすることが出来ます。

<Img
  src="/2025/cloud-run-deploy-strategy/url_of_tag.png"
  alt="リビジョン一覧"
/>

上記の例では`dev`タグに対して固有のURLが割り当てられていることを確認できます。
この機能により、トラフィックが流れない以外は本番環境と全く同じ環境に対してアクセスすることが出来ます。

## ハイブリッドデプロイ

以上の機能を利用することで、「はじめはトラフィックの流れない状態でデプロイを確認し、その後徐々にトラフィックを流すデプロイ戦略を摂りたい」などのハイブリッドな要件も簡単に満たせます。

1. 新しいリビジョンをトラフィックなしでデプロイする
2. タグを付与して、タグ固有のURLで動作確認を行う
3. 徐々にトラフィックを新しいリビジョンに振り分ける
4. タグを削除する

## まとめ

本稿ではCloud Runを利用したデプロイ戦略について解説しました。
重要なポイントをまとめておきます。

1. Cloud Runのデプロイ単位はリビジョンと呼ばれる
2. リビジョンごとにトラフィックを振り分ける機能を提供している
3. リビジョンにタグを付与することで、該当のリビジョンへ直接アクセスができる
4. これらを組み合わせることでローリングデプロイ、ブルーグリーンデプロイ、ハイブリッドデプロイが実現できる

なお、本稿の検証に利用したソースコードは[TODO]()に公開しています。それではよいデプロイライフを！
