---
title: "2025年版管理コマンドを用いずにKubernetes環境をセットアップする"
createdAt: "2025-05-10"
tags:
  - tech
  - kubernetes
  - googlecloud
type: "techtips"
---

（設定ファイルのテンプレート作成のみ管理コマンドを利用しています。許せサスケ）

以下作業メモ

## VM環境（コントロールプレーン）の用意
Google CloudのVMインスタンスを用いた。
CPU, メモリはデフォルトの状態で良いが、ストレージはデフォ10GBでk8sの要求が20GBだったので上げた

手元のWTからアクセスできるようにしようと思ったが、普通にSSH鍵を登録するとsudoでパスワードを求められるためブラウザウィンドウから操作している。

## VM環境のパラメータ調整

カーネルパラメータを調整しろ。ガンダムもそう言っている。

```
sudo swapoff -a

# カーネルパラメータの設定
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# 設定を適用
sudo sysctl --system

# iptablesがブリッジされたトラフィックを処理できるようにモジュールをロード
sudo modprobe br_netfilter
```

## コンテナランタイムのインストール

### containerd, runcのインストール

https://github.com/containerd/containerd/blob/main/docs/getting-started.md#option-2-from-apt-get-or-dnf
を見ると、Docker Engineと同じレポジトリで配布しているので、このリポジトリを登録したうえで`containerd.io`をインストールせよ、とある。する。

### CNI pluginsのインストール

また注意点として、
> The containerd.io package contains runc too, but does not contain CNI plugins.
とある通り、CNIプラグインの別途インストールが必要になる（はず）。

AIに訊ねると

```
https://github.com/containerd/containerd/blob/main/docs/getting-started.md#option-2-from-apt-get-or-dnf
containerdのgetting startedを見るとcni-plugins-<OS>-<ARCH>-<VERSION>.tgzをインストールせよ、とあるのですが、これはcalicoやweave netなどの製品とは異なったレイヤーのパッケージですか？編集ご質問ありがとうございます。その通りです。containerdのgetting startedで言及されている「cni-plugins-<OS>-<ARCH>-<VERSION>.tgz」は、Calico、Weave Netなどの特定のネットワークソリューションとは異なるレイヤーのパッケージです。
これらの関係を説明します：

CNIプラグインの基本パッケージ（cni-plugins-<OS>-<ARCH>-<VERSION>.tgz）

これは、CNI仕様に準拠した基本的なリファレンス実装を含むパッケージです
基本的なネットワーク機能（bridge、host-local、loopback、dhcp、macvlan、ipvlanなど）を提供する低レベルのプラグイン集です
コンテナランタイム（containerdなど）がCNIと連携するために必要な最小限のコンポーネント


CNIネットワークソリューション（Calico、Flannel、Weave Netなど）

これらは上記の基本CNIプラグインの上に構築された高レベルのネットワークソリューションです
より高度な機能（ネットワークポリシー、暗号化、クロスノード通信など）を提供します
Kubernetes環境での実際のネットワーク管理に使用されます



つまり、containerdのドキュメントで言及されている基本CNIプラグインのインストールは、コンテナランタイムがCNI仕様と連携するための基礎となるもので、実際の本番環境ではその上にCalico、Flannel、Weave Netなどの完全なネットワークソリューションをさらにインストールするのが一般的です。
これは車に例えると、基本CNIプラグインは車のエンジンやトランスミッションのような基本部品で、CalicoやWeave Netなどは完成した車のようなものです。基本部品がないと車は動きませんが、実用的な移動手段としては完成した車が必要というイメージです。
```

つまり、あとでCalicoやWeave netなどの特定のCNIソリューションプラグインを別途導入するが、そのために必要なプラグインのためのプラグイン、ということになる。（AI曰く）
ので、導入する。雑コマンドなので注意。

```
wget https://github.com/containernetworking/plugins/releases/download/v1.7.1/cni-plugins-linux-amd64-v1.7.1.tgz
sudo mkdir -p /opt/cni/bin
sudo tar xzvf /opt/cni/bin/cni-plugins-linux-amd64-v1.7.1.tgz
sudo mv * /opt/cni/bin
```

## Kubernetesコンポーネント（コントロールプレーン）のインストール

コントロールプレーンを構成する主要なソフトはバイナリで配布されているので、これを利用する。
ただし、バイナリだけではだめで、設定ファイルおよび各種プロセスが通信する際に利用する鍵ファイルが必要になる。

### kubeadm, kubelet, kubectlのインストール

https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#installing-kubeadm-kubelet-and-kubectlの手順をなぞる

```
curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /' | sudo tee /etc/apt/sources.list.d/kubernetes.list

sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
```

### 必要なディレクトリ構造の作成

```
sudo mkdir -p /etc/kubernetes/manifests
sudo mkdir -p /etc/kubernetes/pki
sudo mkdir -p /var/lib/kubernetes
sudo mkdir -p /var/lib/etcd
sudo mkdir -p /var/log/kubernetes
```

### PKIインフラストラクチャの構築

cfsslかeasyrsaを利用する。